<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
        integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">

    <!-- map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
        integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
    <style>
        .container-fluid>.row {
            height: 100vh;
        }

        #map {
            height: 100%;
        }

        .btm a {
            font-size: 12px;
            white-space: nowrap;
            text-decoration: none;
            color: white;
        }

        .icon {
            border-radius: 100%;
            background-color: yellow;
            width: 10px;
        }

        p {
            font-size: 12px;
            line-height: 10px;
        }
    </style>

    <title>MAP!</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KHLX2KF378"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-KHLX2KF378');
    </script>

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-PLFLSKH');</script>
    <!-- End Google Tag Manager -->
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PLFLSKH" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="container-fluid">
        <section class="bg-light">
            <nav class="navbar navbar-expand-lg navbar-light bg-light m-auto" style="max-width: 1200px;">
                <div class="container-fluid ">
                    <a class="navbar-brand" href="#"><img
                            src="https://taipei.youbike.com.tw/photos/guide/equipment_2/EN_logo.png" alt=""
                            class="w-25"></a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse " id="navbarNav">
                        <div class="d-flex justify-content-lg-end justify-content-center w-100">
                            <ul class="navbar-nav">
                                <li class="nav-item">
                                    <a class="nav-link active text-center" aria-current="page" href="#">回首頁</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-center" href="#">APP下載</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-center" href="#">活動快報</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-center" href="#">會員登入</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-center" href="#">註冊</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-center" href="#">場站資訊</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-center" href="#">最新消息</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-center" href="#">認識微笑單車</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-center" href="#">使用說明</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-center" href="#">常見說明</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
        </section>

        <section class="bg-info">
            <div class="pic">
                <img src="/name1.png" alt="" style="width: 100%;">
            </div>
            <div class="bluenav bg-info text-white m-auto" style="max-width: 1200px;">
                <ul class="navbar-nav d-flex flex-row">
                    <li class="nav-item me-3 d-flex">
                        <i class="fas fa-map-marked-alt fs-2 mt-1 me-1"></i>
                        <a class="nav-link active text-white" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="nav-link text-white" href="#">站點地圖.</a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="nav-link text-white" href="#">站點列表.</a>
                    </li>
                    <li class="nav-item me-3">
                        <a class="nav-link text-white" href="#">服務中心資訊</a>
                    </li>
                </ul>
            </div>
        </section>
        <div class="row h-100">
            <label for="country" class="fw-bolder fs-5 text-decoration-underline mt-2 mb-2">站點地圖</label>
            <div class="col-6">
                <!-- <div class="form-group"></div> -->
                <select name="" id="distric" class="form-control form-select" aria-label="Default select example">
                    <!-- option -->
                </select>
            </div>
            <div class="col-6">
                <div class="input-group h-50 mt-auto">
                    <input type="text" class="form-control" placeholder="請輸入站名查詢" aria-label="Recipient's username"
                        aria-describedby="button-addon2">
                    <button class="btn btn-outline-secondary" type="button" id="button-addon2">查詢</button>
                </div>
            </div>
        </div>
        <div class="infoBox table table-bordered table-striped "></div>
        <label for="country" class="fw-bolder fs-5 text-decoration-underline mt-2 mb-2">站點資訊即時訊息</label>

        <div class="row">
            <div class="col-2">
                <label for="country" class="fw-bolder fs-6  mt-2 mb-2">圖示資訊</label>
                <section class="w-100 mt-3 mb-3">
                    <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png"
                        alt="" class="m-auto">
                    <h6 class="d-inline-block">可借數量充足</h6>
                </section>
                <section class="w-100 mt-3 mb-3">
                    <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png"
                        alt="">
                    <h6 class="d-inline-block">可借小於三成</h6>
                </section>
                <section class="w-100 mt-3 mb-3">
                    <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png"
                        alt="">
                    <h6 class="d-inline-block">可借數量不足</h6>
                </section>
                <section class="w-100 mt-3 mb-3 ">
                    <i class="far fa-circle fs-1 text-danger"></i>
                    <h6 class="d-inline-block" style="font-size: 16px; ">場站車輛數大於43輛</h6>
                </section>
            </div>
            <div class="col-10">
                <div id="map">
                </div>
            </div>
        </div>

        <div class="row h-50 bg-secondary ">
            <section class="m-auto" style="max-width: 1200px;">
                <div class="row">
                    <div class="col-4">
                        <ul class="btm ">
                            <li style="list-style:none"><a href="#">相關連結</a></li>
                            <li style="list-style:none"><a href="#">下載專區</a></li>
                            <li style="list-style:none"><a href="#">會員條款</a></li>
                            <li style="list-style:none"><a href="#">隱私權政策</a></li>
                            <li style="list-style:none"><a href="#">聯絡我們</a></li>
                            <li style="list-style:none"><a href="#">微笑徵才</a></li>
                        </ul>
                    </div>
                    <div class="col-4">

                        <div class="box mt-5">
                            <i class="fab fa-facebook text-center"></i>
                            <i class="fab fa-instagram-square"></i>
                            <i class="fab fa-youtube"></i>
                            <i class="fab fa-line"></i>
                        </div>


                    </div>
                    <div class="col-4">
                        <a class="navbar-brand" href="#"><img
                                src="https://taipei.youbike.com.tw/photos/guide/equipment_2/EN_logo.png" alt=""
                                class="w-25"></a>
                        <div class="info">
                            <p>
                                YouBike 1.0服務電話：市民熱線1999轉5855 / 02-89785511(付費)
                                YouBike 2.0服務電話：市民熱線1999(免費)/02-8978-8822(付費)
                                電子信箱： service-taipei@youbike.com.tw
                                ※ 建議使用Google Chrome或是Microsoft Edge瀏覽器開啟。(因微軟將於2021年8月17日起停止支援IE瀏覽器。)
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <!-- <div class="row">
            <div class="col-12 w-100">
                <div id="map">
                </div>
            </div>
        </div> -->
    </div>


    <!-- Axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.25.0/axios.min.js"
        integrity="sha512-/Q6t3CASm04EliI1QyIDAA/nDo9R8FQ/BULoUFyN4n/BDdyIxeH7u++Z+eobdmr11gG5D/6nPFyDlnisDwhpYA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>


    <script>
        //宣告
        let map;
        //台灣行政區域經緯度
        let areaDataRequest = axios.get('https://raw.githubusercontent.com/ChouJustice/ChouJustice.github.io/main/Map/%E5%8F%B0%E7%81%A3%E8%A1%8C%E6%94%BF%E5%9C%B0%E5%8D%80.json')
        //各行政區域 每人平均用水量
        let bikeDataRequest = axios.get('https://raw.githubusercontent.com/JingYi1213/FileStorage/main/bike.json')

        let areaData //行政區經緯度資料
        let bikeData //行政區用水量資料

        let markers = L.markerClusterGroup() //地圖叢集群組
        //DOM
        const districSelect = document.querySelector("#distric")
        const areaText = document.querySelector("strong")
        const tableBody = document.querySelector("tbody")
        const inputDis = document.querySelector("input")
        const inputBtn = document.querySelector("#button-addon2")
        let infoBox = document.querySelector(".infoBox")
        //WINDOW.ONLOAD
        window.onload = function () {
            setMap();
            Promise.all([areaDataRequest, bikeDataRequest])
                .then(response => {
                    // let areaRes = response[0];
                    // let waterRes = response[1];

                    //array，解構
                    let [areaRes, bikeRes] = response;
                    console.log(areaRes)
                    console.log(bikeRes)

                    //area //取出陣列裡的資料
                    areaData = areaRes.data;
                    //water //取出陣列裡的資料(一共四層)
                    bikeData = bikeRes.data
                    // console.log(areaData)
                    // console.log(waterData)


                    //初始設定地圖標籤
                    setMarker()
                    // 初始右側縣市下拉選單
                    let districtArray = areaData.filter(x => x.City == "臺北市")
                    Array.from(["請選擇"].concat([...new Set(districtArray.map(x => x.District))])).forEach(x => {
                        let option = document.createElement("option")
                        option.innerText = x
                        option.value = x == "請選擇" ? '' : x
                        districSelect.appendChild(option)
                    })


                    districSelect.onchange = function () {
                        infoBox.innerText = "";
                        if (districSelect.value != "") {
                            //把地圖焦點移動到該城市
                            let distric = districtArray.find(x => x.District == districSelect.value)
                            map.setView([distric.Lat, distric.Lng], 15)

                            //顯示區域內的站別
                            let th = document.createElement("th");
                            th.innerText = `${districSelect.value}所有場站名稱`;
                            let th2 = document.createElement("th");
                            th2.innerText = "場站總停車格";
                            let th3 = document.createElement("th");
                            th3.innerText = "站點地址"
                            let tem = bikeData.filter(x => x.sarea == districSelect.value)
                            let thearTR = document.createElement("tr")
                            let thead = document.createElement("thead")
                            thearTR.append(th, th2, th3)
                            tem.forEach(x => {
                                let tr = document.createElement("tr")
                                let td = document.createElement("td")
                                td.classList.add("w-25")
                                td.innerText = x.sna
                                let td2 = document.createElement("td")
                                td2.innerText = x.tot
                                td2.classList.add("w-25")
                                let td3 = document.createElement("td")
                                td3.innerText = x.ar
                                td3.classList.add("w-25")
                                tr.append(td, td2, td3)
                                infoBox.append(tr)
                            })
                            thead.appendChild(thearTR)
                            infoBox.append(thead)
                            infoBox.classList.add("w-100", "overflow-scroll")
                            infoBox.style.height = "200px"
                        }

                    }

                    inputBtn.addEventListener("click", showDis)

                    function showDis() {
                        let val = inputDis.value
                        let distric = bikeData.filter(x => x.sna == `YouBike2.0_${val}`)
                        map.setView([distric[0].lat, distric[0].lng], 18)


                        let marker = L.marker([distric[0].lat, distric[0].lng]).addTo(map)
                        marker.bindPopup(`<h5>${distric[0].sna} 站</h5>`).openPopup();
                        setTimeout(function () {
                            map.removeLayer(marker)
                        }, 3000)
                    }
                })


            let circle = L.circle([25.03416068163684, 121.56454962636319], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5,
                radius: 500
            }).addTo(map);
        }

        //FUNCTION
        function setMap() {
            //初始化地圖
            map = L.map('map', {
                center: [25.03416068163684, 121.56454962636319],
                zoom: 15
            })
            //設定圖資
            let osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
            let osm = new L.TileLayer(osmUrl, { minZoom: 8, maxZoom: 19 })
            map.addLayer(osm)

        }

        //array.groupby
        Array.prototype.groupBy = function (prop) {
            return this.reduce(function (groups, item) {
                const val = item[prop];
                groups[val] = groups[val] || [];
                groups[val].push(item);
                return groups;
            }, {});
        }

        let greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        let redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        let orangeIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });


        // L.marker([25.03416068163684, 121.56454962636319], { icon: redIcon })

        function setMarker() {
            if (markers) markers.clearLayers();


            bikeData.forEach(x => {

                let marker;
                if (x.sbi == 0) {
                    marker = L.marker([x.lat, x.lng], { icon: redIcon })
                }
                else if (x.sbi < x.tot * 0.3) {
                    marker = L.marker([x.lat, x.lng], { icon: orangeIcon })
                }
                else {
                    marker = L.marker([x.lat, x.lng], { icon: greenIcon })
                }

                if (x.tot >= 43) {
                    let circle = L.circle([x.lat, x.lng], {
                        color: 'red',
                        fillColor: '#f03',
                        fillOpacity: 0.3,
                        radius: 500
                    }).addTo(map);
                    circle.bindPopup(`${x.sna} 站 <br> 總車數 : ${x.tot} <br> 服務半徑 : 500M`);
                }

                // let marker = L.marker([x.lat, x.lng], { icon: greenIcon })



                marker.bindPopup(
                    `<h5>${x.sna} 站</h5>
                    <ul>
                        <li>場站總停車格 : ${x.tot}</li>
                        <li>場站目前車輛數量 : ${x.sbi}</li>
                        <li>場站目前可停空位 : ${x.bemp}</li>
                        <li>站點地址 : ${x.ar}</li>
                        <li>更新時間 : ${x.updateTime}</li>
                        </ul>
                    `
                )


                markers.addLayer(marker)
            })

            map.addLayer(markers)
        }


    </script>

    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>


</body>

</html>